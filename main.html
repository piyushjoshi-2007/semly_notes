<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Semly — Your Semester, Simplified</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- THEMING --- */
        :root{
            --bg:#080a12; /* Deeper Dark Blue */
            --card:#101320; /* Dark Blue Surface */
            --muted:#a0aec0;
            --text:#edf2f7;
            --accent:#4c51bf; /* Royal Purple */
            --accent-light:#7f9cf5;
            --glass: rgba(255,255,255,0.06);
            --radius:16px;
            --container:1200px;
            font-family: 'Poppins', 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            font-size: 16px;
        }

        /* Reset and Base Styles */
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#050609);color:var(--text);transition:background-color 0.4s}
        a{color:var(--accent-light);text-decoration:none}
        a:hover{color:var(--text)}

        .wrap{max-width:var(--container);margin:40px auto;padding:0 24px}

        /* --- Components --- */
        .btn{
            background:transparent;
            border:1px solid rgba(255,255,255,0.1);
            padding:10px 18px;
            border-radius:12px;
            color:var(--text);
            cursor:pointer;
            font-weight:600;
            transition:all 0.3s;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        .btn:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
        .btn.primary{
            background:linear-gradient(135deg,var(--accent-light),var(--accent));
            border:none;
            color:var(--bg);
            font-weight:700;
            box-shadow:0 6px 20px rgba(76,81,191,0.3);
        }
        .btn.primary:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(76,81,191,0.4)}
        
        /* --- THEMED SELECT/DROPDOWN FIX --- */
        .select, .input-field{
            width:100%;
            background:var(--card); /* Darker background */
            border:1px solid rgba(255,255,255,0.1);
            padding:12px;
            border-radius:10px;
            color:var(--text);
            font-size:1em;
            transition:border-color 0.3s;
            /* Reset/customize appearance for select */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23a0aec0'%3e%3cpath d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3e%3c/svg%3e"); 
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 1em;
            padding-right: 30px;
        }
        .select:focus, .input-field:focus{border-color:var(--accent-light);outline:none;}
        /* Ensure options stay dark on dropdown open (browser dependent but helps) */
        .select option {
            background-color: var(--card); 
            color: var(--text); 
        }

        textarea.input-field{resize:vertical;min-height:100px}
        label{display:block;color:var(--muted);font-size:0.9em;margin-top:8px}


        /* Header */
        header{display:flex;align-items:center;gap:20px;margin-bottom:40px}
        .logo{display:flex;align-items:center;gap:12px}
        .logo .mark{width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-light));display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(76,81,191,0.2);font-weight:800;font-size:1.8em}
        .brand{line-height:1}
        .brand h1{margin:0;font-size:24px;letter-spacing:0.5px}
        .brand p{margin:0;color:var(--muted);font-size:14px}
        .header-actions{margin-left:auto;display:flex;gap:10px}

        /* Hero */
        .hero{display:grid;grid-template-columns:2fr 1fr;gap:36px;align-items:center;margin-bottom:40px}
        .hero-card{
            background:var(--card);
            padding:32px;
            border-radius:var(--radius);
            box-shadow:0 15px 50px rgba(0,0,0,0.5);
            border:1px solid rgba(255,255,255,0.06);
            backdrop-filter:blur(5px);
        }
        .hero h2{margin:0 0 16px;font-size:2.5em;font-weight:700}
        .hero p{margin:0;color:var(--muted);font-size:1.1em}
        .features{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
        .chip{padding:10px 16px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.1);font-size:14px;color:var(--accent-light)}
        .search{display:flex;gap:10px;margin-top:16px}
        .search input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.4);color:var(--text)}

        .hero-side{background:var(--card);padding:24px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.06)}

        /* Courses grid (Dynamic Synchronization Area) */
        .courses{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
        .course-card, .sync-card {
            background:var(--card);
            padding:20px;
            border-radius:var(--radius);
            border:1px solid rgba(255,255,255,0.08);
            cursor:pointer;
            transition:all 0.3s;
        }
        .course-card:hover, .sync-card:hover{
            border-color:var(--accent);
            transform:translateY(-3px);
            box-shadow:0 10px 30px rgba(76,81,191,0.15);
        }
        .course-card h3, .sync-card h3{margin:0 0 8px;font-size:1.4em;color:var(--accent-light)}
        .meta{font-size:14px;color:var(--muted)}
        .breadcrumb-sync{margin-bottom:20px;font-size:1.1em;color:var(--muted);}
        .breadcrumb-sync a{cursor:pointer;margin-right:8px}


        /* Content area */
        .content{display:flex;gap:30px;margin-top:30px}
        .left{flex:1}
        .right{width:340px}
        
        /* Filters */
        .filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .filters .select{margin-bottom:0;width:auto}

        /* Notes list */
        .notes-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
        .note{
            background:var(--card);
            padding:18px;
            border-radius:12px;
            border:1px solid rgba(255,255,255,0.05);
            transition:border-color 0.3s;
            cursor:pointer;
        }
        .note:hover{border-color:var(--accent)}
        .note h4{margin:0;font-size:1.1em;color:var(--text)}
        .note p{margin:8px 0 0;color:var(--muted);font-size:0.9em}
        .note .meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
        .vote{display:flex;gap:8px;align-items:center}
        .vote button{
            background:var(--glass);
            border:1px solid rgba(255,255,255,0.1);
            color:var(--text);
            padding:6px 10px;
            border-radius:8px;
            cursor:pointer;
            transition:background-color 0.2s;
        }
        .vote button:hover{background:var(--accent-light);color:var(--bg)}
        .vote-count{min-width:30px;text-align:center;font-weight:600}
        .badge{background:var(--glass);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);font-size:12px;color:var(--accent-light)}
        .vote .primary { /* Highlight active vote */
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }


        /* Right column */
        .upload-card{
            background:var(--card);
            padding:20px;
            border-radius:var(--radius);
            margin-bottom:20px;
            border:1px solid rgba(255,255,255,0.06);
        }
        .upload-card p{color:var(--muted);font-size:0.9em}
        .u-btn{display:block;width:100%;padding:14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-light));color:var(--bg);font-weight:700;cursor:pointer;transition:transform 0.3s;margin-top:10px}
        .u-btn:hover{transform:translateY(-1px);opacity:0.9}

        /* Footer */
        footer{margin-top:40px;padding:20px;text-align:center;color:var(--muted);font-size:0.9em;border-top:1px solid rgba(255,255,255,0.05)}

        /* Modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.3s}
        .modal{
            background:var(--card);
            padding:24px;
            border-radius:var(--radius);
            width:900px;
            max-width:90%;
            border:1px solid rgba(255,255,255,0.1);
            box-shadow:0 10px 40px rgba(0,0,0,0.7);
        }
        .modal h3{color:var(--accent-light)}
        .modal .row{display:flex;gap:20px}
        .modal .col{flex:1}
        /* Spacing improvement for upload form */
        .form-group{margin-bottom:15px}
        .form-group label{margin-bottom:5px;margin-top:0}
        .form-group .select, .form-group .input-field{margin-bottom:0}

        /* Responsive */
        @media (max-width:1100px){.notes-grid{grid-template-columns:1fr}}
        @media (max-width:980px){.hero{grid-template-columns:1fr}.content{flex-direction:column}.right{width:100%}.notes-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:700px){.wrap{padding:0 16px}.header-actions{display:none}.notes-grid{grid-template-columns:1fr}.modal .row{flex-direction:column}}
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="logo">
                <div class="mark">S</div>
                <div class="brand"><h1>Semly</h1><p>Organized notes · semester-wise · AI-ready</p></div>
            </div>
            <div class="header-actions">
                <button class="btn" id="themeToggle"><i class="fas fa-sun"></i> Light</button>
                <button class="btn" id="contribBtn"><i class="fab fa-github"></i> Contribute</button>
                <button class="btn primary" id="uploadOpen"><i class="fas fa-cloud-upload-alt"></i> Upload Notes</button>
            </div>
        </header>

        <section class="hero">
            <div class="hero-card">
                <h2>Your **Semester**, simplified — Semly</h2>
                <p>Find concise notes, unit-wise summaries, past year questions & flashcards — organized by **Year → Semester → Subject → Unit**. Built for B.Tech students who want clarity, not clutter.</p>
                <div class="features">
                    <div class="chip"><i class="fas fa-book"></i> Unit-wise notes</div>
                    <div class="chip"><i class="fas fa-check-circle"></i> Verified by seniors</div>
                    <div class="chip"><i class="fas fa-robot"></i> Auto-summarize (coming soon)</div>
                </div>

                <div style="margin-top:24px">
                    <h4 style="margin:0 0 10px;color:var(--accent-light)">Quick search</h4>
                    <div class="search"><input id="globalSearch" class="input-field" style="margin:0" placeholder="e.g. Analog Electronics Unit 3"/><button class="btn primary" id="searchBtn"><i class="fas fa-search"></i> Search</button></div>
                </div>
            </div>

            <aside class="hero-side">
                <h4 style="margin:0 0 10px;color:var(--accent-light)">Get started</h4>
                <p style="margin:0;color:var(--muted)">Choose your course and year, or upload notes for others.</p>
                <div style="margin-top:16px">
                    <label>Select Course</label>
                    <select id="startCourse" class="select">
                        <option value="BTECH">B.Tech</option>
                        <option value="BCA">BCA</option>
                        <option value="MBA">MBA</option>
                        <option value="BBA">BBA</option>
                        <option value="MCA">MCA</option>
                    </select>
                </div>
            </aside>
        </section>

        <section id="sync-section">
            <h3 style="margin:6px 0 16px;font-size:1.8em;color:var(--text)">Browse Synchronized Courses</h3>
            <div class="breadcrumb-sync" id="courseBreadcrumb"></div>
            <div class="courses" id="coursesList">
                </div>
        </section>

        <div class="content">
            <div class="left">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h3 style="margin:0;font-size:1.5em;color:var(--accent-light)">Notes Feed</h3>
                    <div style="color:var(--muted);font-size:14px">Showing <span id="notesCount">0</span> results</div>
                </div>

                <div class="filters" style="margin-top:12px">
                    <select id="filterCourse" class="select"></select>
                    <select id="filterYear" class="select"></select>
                    <select id="filterSem" class="select"></select>
                    <select id="filterBranch" class="select"></select>
                    <button class="btn" id="clearFilters"><i class="fas fa-sync-alt"></i> Clear Filters</button>
                </div>

                <div class="notes-grid" id="notesGrid"></div>
            </div>

            <aside class="right">
                <div class="upload-card">
                    <h4 style="margin:0 0 10px;color:var(--accent-light)">Contribute Notes</h4>
                    <p>Help your peers! Contribute your notes via GitHub (recommended for permanent storage) or use the quick upload.</p>
                    <button class="u-btn" id="uploadOpen2"><i class="fas fa-file-upload"></i> Quick Upload</button>
                    <div style="margin-top:15px;font-size:14px;color:var(--muted)">
                        For permanent contribution, open our GitHub repository: <a id="githubContrib" href="#" target="_blank"><i class="fab fa-github"></i> Open Repo</a>
                    </div>
                </div>

                <div class="upload-card">
                    <h4 style="margin:0 0 10px;color:var(--accent-light)">Top Contributors</h4>
                    <div id="topContrib" style="font-size:0.9em">No contributors yet</div>
                </div>
            </aside>
        </div>

        <footer>Semly · Built for students · <span id="yearFooter"></span></footer>
    </div>

    <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h3 style="margin:0">Upload Notes (Quick Save)</h3>
                <button class="btn" id="modalClose"><i class="fas fa-times"></i> Close</button>
            </div>
            <div class="modal-row row">
                <div class="col">
                    <div class="form-group">
                        <label>Course</label>
                        <select id="uCourse" class="select input-field"><option>BTECH</option><option>BCA</option><option>MBA</option><option>BBA</option><option>MCA</option></select>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <select id="uYear" class="select input-field"><option>1</option><option>2</option><option>3</option><option>4</option></select>
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <select id="uSem" class="select input-field"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option></select>
                    </div>
                    <div class="form-group">
                        <label>Branch</label>
                        <input id="uBranch" class="input-field" placeholder="e.g. CSE, ECE, IT" />
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Subject</label>
                        <input id="uSubject" class="input-field" placeholder="e.g. Analog Electronics" />
                    </div>
                    <div class="form-group">
                        <label>Unit / Topic</label>
                        <input id="uUnit" class="input-field" placeholder="e.g. Unit 2 - Amplifiers" />
                    </div>
                    <div class="form-group">
                        <label>Notes Content (Paste text or link)</label>
                        <textarea id="uContent" class="input-field" style="height:150px"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Your Name/ID</label>
                        <input id="uContrib" class="input-field" placeholder="e.g. roll_no@gehu" value="you" />
                    </div>
                </div>
            </div>
            <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                <button class="btn" id="saveLocal"><i class="fas fa-save"></i> Save locally</button>
                <button class="btn primary" id="createIssue"><i class="fab fa-github"></i> Contribute on GitHub</button>
            </div>
            <div style="margin-top:15px;color:var(--muted);font-size:0.85em">
                *Note: Local save is temporary (browser-only). Use the **Contribute on GitHub** button for permanent, shareable notes.
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="noteModalBackdrop">
        <div class="modal" id="noteModalContent">
            </div>
    </div>

    <script>
        // --- DATA & UTILITIES ---
        // New Nested Data Structure for Synchronization
        const COURSE_DATA = {
            'BTECH': {
                name: "B.Tech (Bachelor of Technology)",
                years: {
                    1: { name: "First Year", sems: { 1: ["Applied Physics", "Applied Chemistry", "Engineering Mathematics I", "Basic Electronics"], 2: ["Applied Mechanics", "Basic Electrical Engg", "Engineering Mathematics II", "Programming in C"] } },
                    2: { name: "Second Year", sems: { 3: ["Data Structures (CSE/IT)", "Digital Logic", "Discrete Maths"], 4: ["Operating Systems (CSE/IT)", "DBMS", "Software Engineering"] } },
                    3: { name: "Third Year", sems: { 5: ["Compiler Design", "TOC", "Web Technology"], 6: ["AI & ML", "Cloud Computing", "Elective I"] } },
                    4: { name: "Fourth Year", sems: { 7: ["Distributed Systems", "Cryptography", "Project"], 8: ["Elective III", "Seminar", "Industrial Training"] } }
                }
            },
            'BCA': {
                name: "BCA (Bachelor of Computer Applications)",
                years: {
                    1: { name: "First Year", sems: { 1: ["Programming in C", "Digital Electronics", "Business Communication"], 2: ["OOP with C++", "Data Structures", "Web Designing"] } }
                }
            },
            'MBA': {
                name: "MBA (Master of Business Administration)",
                years: {
                    1: { name: "First Year", sems: { 1: ["Management Concepts", "Business Economics", "Financial Accounting"] } }
                }
            },
            'BBA': { name: "BBA (Bachelor of Business Administration)", years: {} },
            'MCA': { name: "MCA (Master of Computer Applications)", years: {} }
        };

        const SAMPLE_NOTES = [
            {id:genId(),course:'BTECH',year:2,sem:3,branch:'CSE',subject:'Data Structures (CSE/IT)',unit:'Unit 2 - Trees',content:'Download Link: [Drive Link]. Binary search trees, AVL trees, and traversal algorithms explained. This is a high quality note.',votes:12,contrib:'rahul@gehu'},
            {id:genId(),course:'BTECH',year:3,sem:5,branch:'ECE',subject:'Web Technology',unit:'Unit 1 - HTML Basics',content:'Basics of HTML5 and CSS selectors.',votes:8,contrib:'neha@gehu'},
            {id:genId(),course:'BCA',year:1,sem:1,branch:'BCA',subject:'Programming in C',unit:'Unit 3 - Pointers',content:'Pointers and arrays explained with examples and diagrams (see link). Very important for labs.',votes:5,contrib:'ankit@gehu'}
        ];

        const LS_KEY = 'semly_notes_v3';
        const LS_VOTES = 'semly_votes_v3';
        
        function genId(){return 'n_'+Math.random().toString(36).slice(2,9)}
        function loadNotes(){
            const raw = localStorage.getItem(LS_KEY);
            if(raw) return JSON.parse(raw);
            localStorage.setItem(LS_KEY, JSON.stringify(SAMPLE_NOTES));
            return SAMPLE_NOTES;
        }
        function saveNotes(arr){localStorage.setItem(LS_KEY, JSON.stringify(arr));}
        function loadVotes(){return JSON.parse(localStorage.getItem(LS_VOTES) || '{}')}
        function saveVotes(v){localStorage.setItem(LS_VOTES, JSON.stringify(v))}
        function truncate(s,len){return s.length>len? s.slice(0,len-1)+'…':s}
        function escapeHtml(s){if(!s) return ''; return s.replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]})}

        // --- DOM REFERENCES & STATE ---
        const coursesList = document.getElementById('coursesList');
        const notesGrid = document.getElementById('notesGrid');
        const notesCount = document.getElementById('notesCount');
        const filterCourse = document.getElementById('filterCourse');
        const filterYear = document.getElementById('filterYear');
        const filterSem = document.getElementById('filterSem');
        const filterBranch = document.getElementById('filterBranch');
        const startCourse = document.getElementById('startCourse');
        const courseBreadcrumb = document.getElementById('courseBreadcrumb');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const noteModalBackdrop = document.getElementById('noteModalBackdrop');
        const noteModalContent = document.getElementById('noteModalContent');
        const githubUrl = 'https://github.com/gehuhaldwani/gehuhaldwani.github.io'; 

        let notes = loadNotes();
        let votes = loadVotes();
        let currentPath = { level: 'course', course: null, year: null, sem: null, subject: null };


        // --- DYNAMIC HIERARCHY RENDER FUNCTIONS ---
        
        function updateBreadcrumb() {
            let html = `<a onclick="setPath('course')"><i class="fas fa-home"></i> All Courses</a>`;
            if (currentPath.course) {
                const courseName = COURSE_DATA[currentPath.course].name;
                html += ` / <a onclick="setPath('year', '${currentPath.course}')">${courseName}</a>`;
            }
            if (currentPath.year) {
                const yearName = COURSE_DATA[currentPath.course].years[currentPath.year].name;
                html += ` / <a onclick="setPath('sem', '${currentPath.course}', ${currentPath.year})">${yearName}</a>`;
            }
            if (currentPath.sem) {
                html += ` / <a onclick="setPath('subject', '${currentPath.course}', ${currentPath.year}, ${currentPath.sem})">Semester ${currentPath.sem}</a>`;
            }
            courseBreadcrumb.innerHTML = html;
        }

        function setPath(level, course = null, year = null, sem = null, subject = null) {
            currentPath.level = level;
            currentPath.course = course;
            currentPath.year = year;
            currentPath.sem = sem;
            currentPath.subject = subject;
            renderHierarchy();
        }

        function renderHierarchy() {
            coursesList.innerHTML = '';
            updateBreadcrumb();
            
            // 1. Show Courses (Initial View)
            if (currentPath.level === 'course') {
                Object.keys(COURSE_DATA).forEach(key => {
                    const data = COURSE_DATA[key];
                    const div = document.createElement('div');div.className='course-card';
                    div.innerHTML = `<h3>${data.name} (${key})</h3><div class='meta'>Years: ${Object.keys(data.years).length || 'N/A'} · Click to select year</div>`;
                    div.addEventListener('click',()=>setPath('year', key));
                    coursesList.appendChild(div);
                });
            } 
            
            // 2. Show Years
            else if (currentPath.level === 'year') {
                const years = COURSE_DATA[currentPath.course].years;
                Object.keys(years).forEach(key => {
                    const data = years[key];
                    const div = document.createElement('div');div.className='sync-card';
                    div.innerHTML = `<h3>${data.name}</h3><div class='meta'>Years: ${data.name} · Click to select semester</div>`;
                    div.addEventListener('click',()=>setPath('sem', currentPath.course, Number(key)));
                    coursesList.appendChild(div);
                });
            }

            // 3. Show Semesters
            else if (currentPath.level === 'sem') {
                const sems = COURSE_DATA[currentPath.course].years[currentPath.year].sems;
                Object.keys(sems).forEach(key => {
                    const subjects = sems[key].length;
                    const div = document.createElement('div');div.className='sync-card';
                    div.innerHTML = `<h3>Semester ${key}</h3><div class='meta'>${subjects} Subjects · Click to view subjects</div>`;
                    div.addEventListener('click',()=>setPath('subject', currentPath.course, currentPath.year, Number(key)));
                    coursesList.appendChild(div);
                });
            }

            // 4. Show Subjects / Notes
            else if (currentPath.level === 'subject') {
                const subjects = COURSE_DATA[currentPath.course].years[currentPath.year].sems[currentPath.sem];
                
                // Show a card for each subject
                subjects.forEach(subjectName => {
                    const matchingNotes = notes.filter(n => 
                        n.course === currentPath.course && 
                        n.year === currentPath.year && 
                        n.sem === currentPath.sem && 
                        n.subject === subjectName
                    ).length;

                    const div = document.createElement('div');div.className='sync-card';
                    div.innerHTML = `
                        <h3>${subjectName}</h3>
                        <div class='meta'>${matchingNotes} Notes Available</div>
                        <button class="btn primary" style="padding: 8px 12px; font-size: 0.9em; margin-top: 10px; border:none;" onclick="filterAndScroll('${subjectName}')">
                            <i class="fas fa-search"></i> View Notes
                        </button>
                    `;
                    coursesList.appendChild(div);
                });

                // Option for No Notes Found
                if(subjects.length === 0) {
                    coursesList.innerHTML = `<div style="color:var(--muted);padding:20px;text-align:center">No subjects found for this semester.</div>`;
                }
            }
        }
        
        function filterAndScroll(subjectName) {
            // Apply filtering based on the currently selected path and the final subject
            filterCourse.value = currentPath.course;
            filterYear.value = currentPath.year;
            filterSem.value = currentPath.sem;
            document.getElementById('globalSearch').value = subjectName; // Put subject name in search bar
            applyFilters();
            
            // Scroll down to the notes section
            document.querySelector('.content').scrollIntoView({ behavior: 'smooth' });
        }


        // --- RENDER & FILTER FUNCTIONS ---

        function renderFilters(){
            const courses = ['ALL',...Object.keys(COURSE_DATA)];
            const years = ['ALL',1,2,3,4,5];
            const semesters = ['ALL',1,2,3,4,5,6,7,8,9,10];
            const branches = ['ALL','CSE','ECE','ME','CE','IT','BCA','BBA','MBA','M.Tech'];

            const populateSelect = (select, options) => {
                select.innerHTML = '';
                options.forEach(x => {
                    const o = document.createElement('option');
                    o.value = x;
                    o.textContent = x;
                    select.appendChild(o);
                });
            };

            populateSelect(filterCourse, courses);
            populateSelect(filterYear, years);
            populateSelect(filterSem, semesters);
            populateSelect(filterBranch, branches);
            
            // Sync startCourse options
            populateSelect(startCourse, Object.keys(COURSE_DATA));
            startCourse.value = 'BTECH';
        }

        function renderNotes(list){
            notesGrid.innerHTML='';
            notesCount.textContent = list.length;
            if(list.length===0){notesGrid.innerHTML='<div style="color:var(--muted);padding:20px;text-align:center">No notes found matching your criteria. Try clearing filters or contribute new notes.</div>';return}
            
            list.forEach(n=>{
                const div = document.createElement('div');div.className='note';
                const voteDelta = votes[n.id] || 0;
                const voteCount = (n.votes || 0) + voteDelta;
                
                div.innerHTML = `
                    <h4><i class="fas fa-file-alt"></i> ${escapeHtml(n.subject)} · <span style='color:var(--muted);font-size:0.8em'>${escapeHtml(n.unit)}</span></h4>
                    <p class='meta'>${escapeHtml(n.branch)} · Y ${n.year} · S ${n.sem}</p>
                    <p style='margin-top:10px'>${escapeHtml(truncate(n.content,100))}</p>
                    <div class='meta-row'>
                        <div class='badge'>By ${escapeHtml(n.contrib || 'unknown')}</div>
                        <div class='vote'>
                            <button data-id='${n.id}' class='up ${voteDelta > 0 ? 'primary' : ''}' title='Upvote'><i class="fas fa-arrow-up"></i></button>
                            <div class='vote-count'>${voteCount}</div>
                            <button data-id='${n.id}' class='down ${voteDelta < 0 ? 'primary' : ''}' title='Downvote'><i class="fas fa-arrow-down"></i></button>
                        </div>
                    </div>`;

                // click to open full
                div.addEventListener('click', (e)=>{ if(!e.target.closest('.vote button')){openNote(n)} });
                notesGrid.appendChild(div);
            })

            // Attach vote handlers
            document.querySelectorAll('.up').forEach(b=>b.addEventListener('click', (e)=>{e.stopPropagation();vote(e.target.closest('button').dataset.id,1)}))
            document.querySelectorAll('.down').forEach(b=>b.addEventListener('click', (e)=>{e.stopPropagation();vote(e.target.closest('button').dataset.id,-1)}))
        }

        function openNote(n){
            noteModalContent.innerHTML = `
                <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:15px'>
                    <h3 style='margin:0'>${escapeHtml(n.subject)} — ${escapeHtml(n.unit)}</h3>
                    <div style='display:flex;gap:10px'>
                        <button class='btn copy-link' data-content='${window.location.href.split('#')[0]}#note-${n.id}'><i class="fas fa-copy"></i> Copy Link</button>
                        <button class='btn' id='noteModalClose'><i class="fas fa-times"></i> Close</button>
                    </div>
                </div>
                <div style='margin-top:12px;color:var(--muted);font-size:0.9em'>
                    ${escapeHtml(n.course)} · ${escapeHtml(n.branch)} · Year ${n.year} · Sem ${n.sem} · Contributed by ${escapeHtml(n.contrib||'unknown')}
                </div>
                <pre style='white-space:pre-wrap;margin-top:20px;padding:15px;background:rgba(0,0,0,0.3);border-radius:10px;max-height:40vh;overflow-y:auto;color:var(--text)'>${escapeHtml(n.content)}</pre>
                <div style='margin-top:15px;text-align:right'>
                    <a href="javascript:void(0);" target="_blank" class="btn primary" style="padding:8px 15px;font-size:0.9em" onclick="alert('Simulated Download: In a real environment, this button would fetch the note file or navigate to the source link mentioned in the note content.');"><i class="fas fa-download"></i> Download / View Source</a>
                </div>
            `;
            
            // Add event listeners for the new modal
            document.getElementById('noteModalClose').addEventListener('click',()=>noteModalBackdrop.style.display='none');
            document.querySelector('.copy-link').addEventListener('click', handleCopyLink);
            
            noteModalBackdrop.style.display='flex';
        }

        function vote(id, delta){
            const currentVote = votes[id] || 0;
            let newVote = currentVote;
            
            if (currentVote === delta) { newVote = 0; } 
            else if (currentVote === -delta) { newVote = delta; } 
            else { newVote = delta; }

            votes[id] = newVote; 
            saveVotes(votes); 
            renderNotes(applyCurrentFilters(notes)); 
            updateTopContrib();
        }

        function handleCopyLink(e) {
            const link = e.currentTarget.dataset.content;
            navigator.clipboard.writeText(link).then(() => {
                const originalText = e.currentTarget.innerHTML;
                e.currentTarget.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => { e.currentTarget.innerHTML = originalText; }, 1500);
            }).catch(err => {
                alert('Could not copy link: ' + link);
            });
        }

        // --- FILTERING & UPLOADS ---

        function applyCurrentFilters(listIn){
            let list = listIn || loadNotes();
            const fc = filterCourse.value; const fy=filterYear.value; const fs=filterSem.value; const fb=filterBranch.value; const q=document.getElementById('globalSearch').value.trim().toLowerCase();
            
            if(fc && fc!=='ALL') list = list.filter(x=>x.course===fc);
            if(fy && fy!=='ALL') list = list.filter(x=>String(x.year)===String(fy));
            if(fs && fs!=='ALL') list = list.filter(x=>String(x.sem)===String(fs));
            if(fb && fb!=='ALL') list = list.filter(x=>String(x.branch).toLowerCase().includes(String(fb).toLowerCase()));
            
            // QUICK SEARCH: Check subject, unit, content, AND branch
            if(q) list = list.filter(x=> (x.subject + ' ' + x.unit + ' ' + x.content + ' ' + x.branch).toLowerCase().includes(q));

            // sort by votes + contributions
            list.sort((a,b)=> ( (b.votes || 0)+(votes[b.id]||0) ) - ( (a.votes||0)+(votes[a.id]||0) ) );
            return list;
        }

        function applyFilters(){renderNotes(applyCurrentFilters())};

        // Upload handlers
        document.getElementById('uploadOpen').addEventListener('click',()=>modalBackdrop.style.display='flex');
        document.getElementById('uploadOpen2').addEventListener('click',()=>modalBackdrop.style.display='flex');
        document.getElementById('modalClose').addEventListener('click',()=>modalBackdrop.style.display='none');
        
        document.getElementById('saveLocal').addEventListener('click',()=>{
            const newNote = {
                id:genId(),
                course:document.getElementById('uCourse').value,
                year:Number(document.getElementById('uYear').value),
                sem:Number(document.getElementById('uSem').value),
                branch:document.getElementById('uBranch').value.toUpperCase()||'UNKNOWN',
                subject:document.getElementById('uSubject').value||'Untitled',
                unit:document.getElementById('uUnit').value||'General',
                content:document.getElementById('uContent').value||'No content provided.',
                votes:0,
                contrib:document.getElementById('uContrib').value||'anonymous'
            };
            notes.unshift(newNote); 
            saveNotes(notes); 
            modalBackdrop.style.display='none'; 
            renderNotes(applyCurrentFilters(notes)); // REFLECTS NOTE
            updateTopContrib();
            alert('Note saved locally! For others to see, please contribute via GitHub.');
        });

        // GitHub Integration (same as before)
        document.getElementById('contribBtn').addEventListener('click',()=>{window.open(githubUrl,'_blank')});
        document.getElementById('githubContrib').href = githubUrl;
        document.getElementById('createIssue').addEventListener('click', ()=>{ 
            const subjectVal = document.getElementById('uSubject').value;
            const contentVal = document.getElementById('uContent').value;
            const title = encodeURIComponent(`[New Note] ${subjectVal||'Untitled Note'} - ${document.getElementById('uUnit').value||'General'}`);
            const body = encodeURIComponent(
                `**Note Submission Details**\n\n` +
                `* Course: ${document.getElementById('uCourse').value}\n` +
                `* Year: ${document.getElementById('uYear').value}\n` +
                `* Semester: ${document.getElementById('uSem').value}\n` +
                `* Branch: ${document.getElementById('uBranch').value}\n` +
                `* Subject: ${subjectVal}\n` +
                `* Unit: ${document.getElementById('uUnit').value}\n` +
                `* Contributor: ${document.getElementById('uContrib').value}\n\n` +
                `**Content/Link:**\n\n` +
                `${contentVal}\n\n` +
                `*Please review and merge.*`
            );
            window.open(githubUrl + '/issues/new?title='+title+'&body='+body,'_blank');
        });

        // Search & Filter Events
        document.getElementById('searchBtn').addEventListener('click', applyFilters);
        document.getElementById('globalSearch').addEventListener('keydown',(e)=>{if(e.key==='Enter') applyFilters()});
        ['filterCourse','filterYear','filterSem','filterBranch'].forEach(id=>document.getElementById(id).addEventListener('change', applyFilters));
        document.getElementById('clearFilters').addEventListener('click',()=>{
            document.getElementById('globalSearch').value = '';
            renderFilters();
            applyFilters();
        });
        
        // Connect the "Get Started" Select to the main synchronization area
        document.getElementById('startCourse').addEventListener('change', (e) => {
            const selectedCourse = e.target.value;
            setPath('year', selectedCourse);
            document.getElementById('sync-section').scrollIntoView({ behavior: 'smooth' });
        });


        // Theme Toggle (Simplified)
        const themeToggle = document.getElementById('themeToggle');
        let isLight = false;
        themeToggle.addEventListener('click',()=>{
            isLight = !isLight;
            const root = document.documentElement.style;
            if(isLight){
                root.setProperty('--bg','#f7fafc');
                root.setProperty('--card','#ffffff');
                root.setProperty('--text','#1a202c');
                root.setProperty('--muted','#718096');
                root.setProperty('--glass','rgba(0,0,0,0.05)');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark';
                themeToggle.classList.add('primary');
            } else {
                root.setProperty('--bg','#080a12');
                root.setProperty('--card','#101320');
                root.setProperty('--text','#edf2f7');
                root.setProperty('--muted','#a0aec0');
                root.setProperty('--glass','rgba(255,255,255,0.06)');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light';
                themeToggle.classList.remove('primary');
            }
        });

        // Top contributors (simple)
        function updateTopContrib(){
            const contrib = {};
            loadNotes().forEach(n=>{contrib[n.contrib] = (contrib[n.contrib]||0)+1});
            const items = Object.entries(contrib).sort((a,b)=>b[1]-a[1]);
            const html = items.length? items.slice(0,6).map(x=>`<div style="margin-bottom:8px;display:flex;justify-content:space-between;border-bottom:1px dashed rgba(255,255,255,0.05);padding-bottom:5px;font-weight:600">${escapeHtml(x[0])} <span style="color:var(--accent-light);font-size:1em">${x[1]} Notes</span></div>`).join('') : 'No contributors yet';
            document.getElementById('topContrib').innerHTML = html;
        }

        // --- INITIALIZATION ---
        renderFilters(); 
        renderNotes(applyCurrentFilters(notes)); 
        setPath('course'); // Start at the course selection level
        document.getElementById('yearFooter').textContent = new Date().getFullYear();
        updateTopContrib();
    </script>
</body>
</html>